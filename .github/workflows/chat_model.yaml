name: load chat model

on: 
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:  

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10"]

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      - name: load model
        run: |
          which python
          date
          python ./demo.py
          #pytest -s -v ./test_1228.py
          #pip install transformers==4.30.2
          #pip install einops
          #pip install torch
          #pip install sentencepiece
          #python internlm2_7b.py
          
      - name: Convert to base64 and embed
        run: |
          # å°†å›¾ç‰‡è½¬æ¢ä¸º base64
          IMG_BASE64=$(base64 -w 0 ./deploy/output_simple.png)
          
          # æ„å»ºå®Œæ•´çš„ summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ğŸ“ˆ åˆ†ææŠ¥å‘Š
          
          ## æ€§èƒ½æ¯”è¾ƒå›¾
          
          ä¸‹å›¾å±•ç¤ºäº†ä¸åŒæ¨¡å‹çš„æ€§èƒ½å¯¹æ¯”ï¼š
          
          <div align="center">
          <img src="https://${{ github.repository_owner }}.github.io/xtuner/${{ github.run_id }}/test11.png" 
               alt="æ€§èƒ½å¯¹æ¯”å›¾" 
               style="max-width: 90%; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          <div align=center>
          <img src="https://raw.githubusercontent.com/kkscilife/xtuner/ci/debug/qwen3-sft_comparison.png" 
          style="width:80%">
          </div>
          <details>
          <summary><strong>ğŸ“Š ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ä¸ç®€è¦åˆ†æ</strong></summary>
          **æ ¸å¿ƒè§‚å¯Ÿ**ï¼šå‰å‡ æ­¥lossä¸‹é™æ˜æ˜¾ï¼ŒTGSåœ¨step 2åç¨³å®šåœ¨9000+ã€‚
          
          ```json
          {"lr": 6e-05, "time/data_time": 0.3072, "time/step_time": 54.9137, "time/train_time": 55.2208, "time/eta_seconds": 878.8, "runtime_info/text_tokens": 65481, "runtime_info/step_consumed_tokens": 523938, "runtime_info/total_consumed_tokens": 523938, "runtime_info/tgs": 1192.4353455532862, "runtime_info/exp_tgs": 1186.0064542343516, "runtime_info/e2e_tgs": 1186.0064542343516, "memory/max_memory_GB": 71.147, "memory/reserved_memory_GB": 74.826, "grad_norm": 23.898910522460938, "loss/local_loss": 2.5080881118774414, "loss/reduced_llm_loss": 2.4380242824554443, "loss/reduced_balancing_loss": 0.07006383687257767, "loss/local_base_loss": 0.30335885286331177, "loss/efficient_attn_ratio": 0.007637234404683113, "step": 1}
          ```
          
          </details>
          
          ## å…³é”®æŒ‡æ ‡
          
          | æ¨¡å‹ | å‡†ç¡®ç‡ | æ¨ç†æ—¶é—´ | å†…å­˜ä½¿ç”¨ |
          |------|--------|----------|----------|
          | Model A | 92.3% | 45ms | 2.1GB |
          | Model B | 94.7% | 52ms | 2.4GB |
          | Model C | 96.1% | 61ms | 2.8GB |
          
          ## ç»“è®º
          - Model C å‡†ç¡®ç‡æœ€é«˜ï¼Œä½†æ¨ç†æ—¶é—´æœ€é•¿
          - éœ€è¦æ ¹æ®å®é™…åœºæ™¯æƒè¡¡é€‰æ‹©
          
          EOF
          echo "test"
          mkdir ./${{ github.run_id }}
          cp ./deploy/qwen3-sft_comparison.png ./${{ github.run_id }}/test11.png
          cp ./deploy/output_simple.png ./${{ github.run_id }}/test12.png

      - name: Deploy to GitHub Pages
        if: ${{ !cancelled() }}
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ github.token }}
          branch: gh-pages
          folder: ./${{ github.run_id }}
          target-folder: ${{ github.run_id }}
